{{ define "main" }}
<header>
    <h1 class="site-title"><a href="/">{{ .Site.Title }}</a></h1>
    <p class="rule">—</p>
</header>

<main>
    <div class="post-content">
        <h2 class="page-title">{{ .Title }}</h2>

        <article class="photo-journal-content">
            {{ partial "highlight-content.html" (dict "Content" .Content) }}
            {{/* Images in this folder that aren't already in the markdown are appended here */}}
            {{ $raw := .RawContent }}
            {{ range .Resources.ByType "image" }}
            {{ if not (strings.Contains $raw .Name) }}
            <img src="{{ .RelPermalink }}" alt="{{ .Name }}" loading="lazy" class="photo-journal-append">
            {{ end }}
            {{ end }}
        </article>

        <p class="post-date">{{ .Date.Format "2006-01-02" }}</p>

        <div class="back-link">
            <a class="arrow-link" href="/photos/">←</a>
        </div>
    </div>
</main>

<div class="lightbox" id="lightbox" role="dialog" aria-modal="true" aria-label="Photo viewer" hidden>
    <button type="button" class="lightbox-close" aria-label="Close">×</button>
    <button type="button" class="lightbox-prev" aria-label="Previous">←</button>
    <button type="button" class="lightbox-next" aria-label="Next">→</button>
    <div class="lightbox-backdrop"></div>
    <div class="lightbox-content">
        <img src="" alt="" id="lightbox-img">
    </div>
</div>
<script>
(function() {
    var content = document.querySelector('.photo-journal-content');
    var lb = document.getElementById('lightbox');
    if (!content || !lb) return;

    var imgs = content.querySelectorAll('img');
    if (imgs.length === 0) return;

    var srcs = [];
    imgs.forEach(function(el) { srcs.push(el.src); });

    var imgEl = document.getElementById('lightbox-img');
    var idx = 0;

    function show(i) {
        idx = (i + srcs.length) % srcs.length;
        imgEl.src = srcs[idx];
        lb.hidden = false;
        document.body.style.overflow = 'hidden';
    }
    function hide() {
        lb.hidden = true;
        document.body.style.overflow = '';
    }
    function setImage(i) {
        idx = (i + srcs.length) % srcs.length;
        imgEl.src = srcs[idx];
    }

    imgs.forEach(function(el, i) {
        el.style.cursor = 'pointer';
        el.addEventListener('click', function() { show(i); });
    });

    lb.querySelector('.lightbox-close').addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        hide();
    });
    lb.querySelector('.lightbox-backdrop').addEventListener('click', hide);
    lb.querySelector('.lightbox-prev').addEventListener('click', function(e) { e.stopPropagation(); setImage(idx - 1); });
    lb.querySelector('.lightbox-next').addEventListener('click', function(e) { e.stopPropagation(); setImage(idx + 1); });

    document.addEventListener('keydown', function(e) {
        if (lb.hidden) return;
        if (e.key === 'Escape') { e.preventDefault(); hide(); }
        else if (e.key === 'ArrowLeft') { e.preventDefault(); setImage(idx - 1); }
        else if (e.key === 'ArrowRight') { e.preventDefault(); setImage(idx + 1); }
    });
})();
</script>

<footer class="site-footer">
    <a href="/about/">Info</a>
    <span class="sep">·</span>
    <a href="/photos/">Photos</a>
</footer>
{{ end }}
